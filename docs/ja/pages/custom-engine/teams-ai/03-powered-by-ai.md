---
search:
  exclude: true
---
# Lab BTA3 - ユーザー体験向上

このラボでは、Teams AI ライブラリが提供する一連の機能である Powered by AI に関して学び、カスタムエンジンエージェントに活用してユーザー体験を向上させる方法を習得します。

このラボでは、以下を実施します:

- Powered by AI 機能について学習する
- ユーザーからのフィードバックを収集するために Feedback Loop を有効にする
- Adaptive Cards を用いて引用情報の表示をカスタマイズする
- Generated by AI ラベルを有効にする
- Sensitivity ラベルを有効にする

<div class="lab-intro-video">
    <div style="flex: 1; min-width: 0;">
        <iframe  src="//www.youtube.com/embed/J7IZULJsagM" frameborder="0" allowfullscreen style="width: 100%; aspect-ratio: 16/9;">          
        </iframe>
          <div>この動画でラボの概要を手早く確認できます。</div>
    </div>
    <div style="flex: 1; min-width: 0;">
        ---8<--- "ja/b-labs-prelude.md"
    </div>
</div>

## 導入

???+ info "Powered by AI とは？"
    Powered by AI は Teams AI ライブラリが提供する一連の機能で、カスタムエンジンエージェントとの対話をより魅力的かつユーザーフレンドリーなものに向上させます。これらの機能には以下が含まれます:

    * **Feedback Loop:** ユーザーは AI の応答に対し、親指の上げ下げで評価できます。このフィードバックにより、時間と共に AI の精度と有用性を向上させることが可能です。

    * **Citations:** AI は情報の出典元を参照し、透明性と信頼性を確保します。
    
    * **Generated by AI:** AI システムによって作成されたメッセージには「AI generated」のラベルが付与され、ユーザーが AI と人間の応答を区別できるようになっています。
    
    * **Sensitivity Information:** 共有される情報が機密性を伴う場合、機密性ラベルが表示され、組織外での共有が可能かどうかを通知します。

前回の演習では、Retrieval-Augmented Generation ( RAG ) とそれがカスタムエンジンエージェントに統合される方法について探求しました。今回の演習では、Powered by AI 機能を活用してユーザー体験を向上させます。以下の手順に従ってください:

- Feedback Loop を実装する
- 引用情報をカスタマイズする
- AI 生成メッセージにラベルを付与する
- 機密性情報を表示する

これらの Powered by AI 機能を取り入れることで、カスタムエンジンエージェントはより透明性があり、信頼性が高く、ユーザーフレンドリーなものとなり、全体のユーザー体験が向上します。

## 演習 1: Feedback Loop の有効化

この演習では、前回のラボで作成したソースコードを引き続き利用できます。

### ステップ 1: アプリに Feedback Loop を統合する

プロジェクト内の `src/app/app.ts` を開き、アプリケーションインスタンスを見つけ、**ai** プロパティの中に `enable_feedback_loop: true` を追加してください。更新後のアプリケーションインスタンスは次のようになります:

```javascript
const app = new Application({
  storage,
  ai: {
    planner,
    //feedback loop is enabled
    enable_feedback_loop: true
  },
});
```

フィードバック応答を処理するため、`src/app/app.ts` に以下のコードスニペットを追加してください:

```javascript
app.feedbackLoop(async (_context, _state, feedbackLoopData) => {
  if (feedbackLoopData.actionValue.reaction === 'like') {
      console.log('👍' + ' ' + feedbackLoopData.actionValue.feedback!);
  } else {
      console.log('👎' + ' ' + feedbackLoopData.actionValue.feedback!);
  }
});
```

<cc-end-step lab="bta3" exercise="1" step="1" />

### ステップ 2: Feedback Loop 機能のテスト

Feedback Loop 機能を組み込んだ Career Genie をテストしましょう。Visual Studio Code の **Run and Debug** タブで **Debug in Teams (Edge)** 又は **Debug in Teams (Chrome)** を選択し、デバッグを開始してください。これにより、ブラウザ上で Microsoft Teams が起動します。Teams 上にアプリ情報が表示されたら、**Add** を選択してアプリとのチャットを開始してください。

!!! tip "ヒント: この演習はローカル環境でテストしてください"
    これまで実装してきた Teams AI ライブラリの機能の一部は、Teams App Test Tool ではスムーズに動作しないため、Teams 上でローカル環境でテストおよびデバッグを行ってください。

Feedback Loop のテストを行う前に、「Hi」や「スペイン語を話せる .NET 開発者を教えて」などの質問を入力してください。すると、カスタムエンジンエージェントからの応答の左下に親指の上げ下げボタンが表示されます。

![Feedback Loop を有効にしたカスタムエンジンエージェントとのチャット UI 。応答の直下に、ユーザーがフィードバックを提供するための親指の上げ下げボタンがあります。](../../../assets/images/custom-engine-03/thumbs-up-down.png)

次に、フィードバックループのテストを行います。親指の上げまたは下げボタンのいずれかをクリックすると、即座にフィードバックカードがポップアップします。カード上のテキストフィールドにフィードバックを入力し、**Submit** をクリックしてください。

![Feedback Loop を有効にし、ユーザーが親指の上げまたは下げボタンを選択した際のカスタムエンジンエージェントとのチャット UI 。詳細なテキスト形式のフィードバックを入力するためのポップアップダイアログと、送信用の「Submit」ボタンがあります。](../../../assets/images/custom-engine-03/feedback-card.png)

フィードバックが記録されたか確認するには、Visual Studio Code に戻りターミナルを確認してください。そこには、親指の上げ下げの評価とコメントを含むフィードバック内容が表示されます。

![ユーザーのフィードバックが、親指の上げと「Copilot Camp rocks!」というフィードバックテキストと共に Visual Studio Code のターミナルに表示されている様子。](../../../assets/images/custom-engine-03/feedback-output.png)

!!! tip "デバッグで Feedback Loop の詳細を確認"
    コードをデバッグすることは、その仕組みを理解するのに最適です。Feedback Loop ハンドラーの動作をより詳しく調査するには、`app.feedbackLoop` にブレークポイントを設定してください。アプリを実行し、親指の上げ下げをクリックしてテストすると、`feedbackLoopData.actionValue.reaction` が評価（リアクション）を、`feedbackLoopData.actionValue.feedback` が入力されたテキストフィードバックを取得しているのを確認できます。

<cc-end-step lab="bta3" exercise="1" step="2" />

## 演習 2: Adaptive Cards による引用情報のカスタマイズ

カスタムエンジンエージェントでデータソースを定義すると、Teams AI ライブラリは関連文書への引用情報を動的に有効にします。カスタムエンジンエージェントでの現状の動作を確認するために、「スペイン語を話せる .NET 開発者を教えて」といった質問をしてみてください。すると、引用部分にカーソルを合わせると文書の冒頭が表示されることに気づくでしょう。

![引用情報が有効になっているカスタムエンジンエージェントとのチャット UI 。応答中のコンテンツの横に引用マークがあり、参照された文書の初期部分を表示するポップアップが表示されます。](../../../assets/images/custom-engine-03/current-citation.png)

この演習では、Adaptive Cards を使用してこの引用体験をさらにカスタマイズし、引用の提示方法を調整します。

### ステップ 1: 引用用 Adaptive Card の作成

`src/app/` フォルダーに移動し、**card.ts** という新しいファイルを作成してください。`card.ts` ファイル内に以下のコードスニペットを追加します:

```javascript
import { AdaptiveCard, Message, Utilities } from '@microsoft/teams-ai';
/**
 * Create an adaptive card from a prompt response.
 * @param {Message<string>} response The prompt response to create the card from.
 * @returns {AdaptiveCard} The response card.
 */

//Adaptive card to display the response and citations
export function createResponseCard(response: Message<string>): AdaptiveCard {
    const citationCards = response.context?.citations.map((citation, i) => ({
            type: 'Action.ShowCard',
            title: `${i+1}`,
            card: {
                type: 'AdaptiveCard',
                body: [
                    {
                        type: 'TextBlock',
                        text: citation.title,
                        fontType: 'Default',
                        weight: 'Bolder'
                    },
                    {
                        type: 'TextBlock',
                        text: citation.content,
                        wrap: true
                    }
                ]
            }
        }));
    
    const text = Utilities.formatCitationsResponse(response.content!);
    return {
        type: 'AdaptiveCard',
        body: [
            {
                type: 'TextBlock',
                text: text,
                wrap: true
            },
            {
                type: 'TextBlock',
                text: 'Citations',
                wrap: true,
                fontType: 'Default',
                weight: 'Bolder'
            },
            {
                type: 'ActionSet',
                actions: citationCards
            }
        ],
        $schema: 'http://adaptivecards.io/schemas/adaptive-card.json',
        version: '1.5'
    };
}
```

この Adaptive Card により、`Action.ShowCard` ボタンとして引用情報をリスト表示し、クリックすると詳細情報が表示されます。また、応答のメインコンテンツと共に引用ボタンも表示されます。もしユーザーが引用情報の詳細を確認したい場合、ボタンをクリックして文書全体を読むことが可能です。

<cc-end-step lab="bta3" exercise="2" step="1" />

### ステップ 2: PredictedSayCommand を用いた引用体験のカスタマイズ

??? info "PredictedSayCommand の役割は？"
    **PredictedSayCommand** は AI システムが実行する応答ディレクティブです。PredictedSayCommand をカスタマイズすることで、引用情報や Feedback Loop などの Powered by AI 機能をカスタムエンジンエージェントの動作に細かく統合でき、アプリケーションのニーズに沿った AI 応答を正確に調整することが可能になります。

`src/app/app.ts` に移動し、Adaptive Card をインポートするために、コードの先頭部分に以下のスニペットを追加してください:

```javascript
import { createResponseCard } from './card';
```

`"botbuilder"` のインポート内に `CardFactory` を追加します。更新後のインポートは以下のようになります:

```javascript
import { CardFactory, MemoryStorage, MessageFactory, TurnContext } from "botbuilder";
```

さらに、"@microsoft/teams-ai" のインポート内に `AI` と `PredictedSayCommand` を追加します。更新後のインポートは以下の通りです:

```javascript
import { Application, ActionPlanner, OpenAIModel, PromptManager, AI, PredictedSayCommand} from "@microsoft/teams-ai";
```

次に、引用をカスタマイズするため、`src/app/app.ts` 内に以下の PredictedSayCommand アクションを追加してください:

```javascript
app.ai.action<PredictedSayCommand>(AI.SayCommandActionName, async (context, state, data, action) => {
  let activity;
  if (data.response.context && data.response.context.citations.length > 0 ) {
      const attachment = CardFactory.adaptiveCard(createResponseCard(data.response));
      activity = MessageFactory.attachment(attachment);
  }
  else {
      activity = MessageFactory.text(data.response.content);
  }

  activity.entities = [
    {
        type: "https://schema.org/Message",
        "@type": "Message",
        "@context": "https://schema.org",
        "@id": ""
    }
  ];
  activity.channelData = {
    feedbackLoopEnabled: true
  };

  await context.sendActivity(activity);

  return "success";
 
});
```

<cc-end-step lab="bta3" exercise="2" step="2" />

### ステップ 3: カスタマイズされた引用体験のテスト

Adaptive Cards によるカスタマイズ済みの引用体験を組み込んだ Career Genie をテストしましょう。Visual Studio Code の **Run and Debug** タブで **Debug in Teams (Edge)** 又は **Debug in Teams (Chrome)** を選択し、デバッグを開始してください。ブラウザ上で Microsoft Teams が起動します。Teams 上にアプリ情報が表示されたら、**Add** を選択してアプリとのチャットを開始してください。

!!! tip "ヒント: この演習はローカル環境でテストしてください"
    これまで実装してきた Teams AI ライブラリの機能の一部は、Teams App Test Tool ではスムーズに動作しないため、Teams 上でローカル環境でテストおよびデバッグを行ってください。

新しい引用体験をテストするには、まず Career Genie に「Hi」または「Hello」とあいさつしてください。そして、「7年以上の経験があり日本語を話せるシニア開発者の候補者を教えて」といった質問を試みてください。

![カスタムエンジンエージェントにおける引用情報の動作を示すアニメーション。プロンプトと応答があり、応答には 3 つの引用が表示され、それぞれの引用には参照先の履歴書が示されています。](../../../assets/images/custom-engine-03/customized-citation.gif)

Adaptive Cards によるカスタマイズされた引用体験では、各引用に対してボタンが提供されています。各引用ボタンをクリックして文書ビューを拡張し、候補者の履歴書詳細を確認してください。

<cc-end-step lab="bta3" exercise="2" step="3" />

## 演習 3: Generated by AI ラベルの有効化

この演習では、`PredictedSayCommand` を使ってカスタムエンジンエージェントのユーザー体験をさらにカスタマイズします。ユーザーが AI と人間の応答を区別できるように、AI システムが作成したメッセージ上部に「AI generated」ラベルを表示します。

### ステップ 1: PredictedSayCommand を用いて Generated by AI ラベルを有効化する

`src/app/app.ts` に移動し、`PredictedSayCommand` アクションを見つけてください。その中の `activity.entities` に以下のコードスニペットを追加します:

```javascript
// Generated by AI label
additionalType: ["AIGeneratedContent"]
```

更新後の `activity.entities` は次のようになります:

```javascript
activity.entities = [
    {
        type: "https://schema.org/Message",
        "@type": "Message",
        "@context": "https://schema.org",
        "@id": "",
        // Generated by AI label
        additionalType: ["AIGeneratedContent"],
    },
    
];
```

<cc-end-step lab="bta3" exercise="3" step="1" />

### ステップ 2: Generated by AI ラベルのテスト

「Generated by AI」ラベルが有効になった Career Genie をテストしましょう。Visual Studio Code の **Run and Debug** タブで **Debug in Teams (Edge)** 又は **Debug in Teams (Chrome)** を選択し、デバッグを開始してください。ブラウザ上で Microsoft Teams が起動します。Teams 上にアプリ情報が表示されたら、**Add** を選択してチャットを開始してください。

!!! tip "ヒント: この演習はローカル環境でテストしてください"
    これまで実装してきた Teams AI ライブラリの機能の一部は、Teams App Test Tool ではスムーズに動作しないため、Teams 上でローカル環境でテストおよびデバッグを行ってください。

「Generated by AI」ラベルのテストを行うには、Career Genie にあいさつしてください。最初の応答メッセージの上部に小さな「AI generated」ラベルが表示されます。

![Generated by AI ラベルが有効になったカスタムエンジンエージェントとのチャット UI 。応答の上部に「AI generated」と表示されるラベルがあります。](../../../assets/images/custom-engine-03/ai-generated.png)

<cc-end-step lab="bta3" exercise="3" step="2" />

## 演習 4: Sensitivity ラベルの有効化

この最終演習では、`PredictedSayCommand` を引き続き使用して、機密性ラベルを有効にします。Career Genie は人事業務の専門家であり、機密性の高い情報を組織内で共有する必要がある場合が多いため、AI 生成メッセージの上部に Sensitivity ラベルが表示され、組織外への共有可否について通知します。

### ステップ 1: PredictedSayCommand を用いて Sensitivity ラベルを有効化する

`src/app/app.ts` に移動し、`PredictedSayCommand` アクションを見つけてください。その中の `activity.entities` に以下のコードスニペットを追加します:

```javascript
// Sensitivity label
usageInfo: {
    "@type": "CreativeWork",
    name: "Confidential",
    description: "Sensitive information, do not share outside of your organization.",
}
```

更新後の `activity.entities` は次のようになります:

```javascript
activity.entities = [
    {
        type: "https://schema.org/Message",
        "@type": "Message",
        "@context": "https://schema.org",
        "@id": "",
        // Generated by AI label
        additionalType: ["AIGeneratedContent"],
        // Sensitivity label
        usageInfo: {
          "@type": "CreativeWork",
          name: "Confidential",
          description: "Sensitive information, do not share outside of your organization.",
        }
    },
    
  ];
```

<cc-end-step lab="bta3" exercise="4" step="1" />

### ステップ 2: Sensitivity ラベルのテスト

Sensitivity ラベルが有効になった Career Genie をテストしましょう。Visual Studio Code の **Run and Debug** タブで **Debug in Teams (Edge)** 又は **Debug in Teams (Chrome)** を選択し、デバッグを開始してください。ブラウザ上で Microsoft Teams が起動します。Teams にアプリ情報が表示されたら、**Add** を選択してチャットを開始してください。

!!! tip "ヒント: この演習はローカル環境でテストしてください"
    これまで実装してきた Teams AI ライブラリの機能の一部は、Teams App Test Tool ではスムーズに動作しないため、Teams 上でローカル環境でテストおよびデバッグを行ってください。

Sensitivity ラベルのテストを行うには、Career Genie にあいさつするか、「スペイン語を話す役割に適した候補者で、少なくとも 2 年の .NET 経験が必要な人を教えて」といった質問を試してください。

![Sensitivity ラベルが有効になったカスタムエンジンエージェントとのチャット UI 。応答の上部、'AI generated' ラベルの隣に機密性シールドのラベルがハイライト表示され、カーソルを合わせると組織固有のガイダンスが表示されるカードがあります。](../../../assets/images/custom-engine-03/sensitivity-label.png)

応答メッセージ内の「AI generated」ラベルのすぐ隣に Sensitivity ラベルが表示されることに注目してください。Sensitivity ラベルにカーソルを合わせると、組織固有のガイダンスが表示されます。

<cc-end-step lab="bta3" exercise="4" step="2" />

---8<--- "ja/b-congratulations.md"

Lab BTA3 - Powered by AI キットを使用したユーザー体験向上を完了しました! さらなる探求を希望する場合、このラボのソースコードは [Copilot Developer Camp repo](https://github.com/microsoft/copilot-camp/tree/main/src/custom-engine-agent/Lab03-Powered-by-AI/CareerGenie){target=_blank} でご覧いただけます。

これで、Lab BTA4 - Secure your solution using authentication へ進む準備が整いました。Next を選択してください。

<cc-next url="../04-authentication" />

<img src="https://m365-visitor-stats.azurewebsites.net/copilot-camp/custom-engine/teams-ai/03-powered-by-ai" />